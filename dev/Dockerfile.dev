FROM registry.tld/cyberark/ubuntu-ruby-builder:22.04 as builder

ENV GEM_HOME=/usr/local/bundle

WORKDIR /src/conjur-server

COPY Gemfile Gemfile.lock ./
COPY ./gems/ ./gems/

RUN bundle

# removing CA bundle of httpclient gem
RUN find / -name httpclient -type d -exec find {} -name "*.pem" -type f -delete \;

FROM registry.tld/cyberark/ubuntu-ruby-fips:22.04
ENV PORT=3000 \
    LOG_DIR=/src/conjur-server/log \
    TMP_DIR=/src/conjur-server/tmp \
    SSL_CERT_DIRECTORY=/src/conjur/etc/ssl \
    GEM_HOME=/usr/local/bundle \
    PATH=/src/conjur-server/bin:$PATH \
    TERM=xterm

RUN mkdir -p /src/conjur-server
WORKDIR /src/conjur-server

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    git \
    jq \
    libfontconfig1 \
    libfontconfig1-dev \
    unattended-upgrades \
    vim \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*
#    && rm -rf /var/lib/apt/lists/* && \
#    rm /etc/service/sshd/down && \
#    rm /etc/my_init.d/10_syslog-ng.init

# Ensure few required GID0-owned folders to run as a random UID (OpenShift requirement)
RUN mkdir -p $TMP_DIR \
             $LOG_DIR \
             $SSL_CERT_DIRECTORY/ca \
             $SSL_CERT_DIRECTORY/cert \
             /run/authn-local

COPY --from=builder /src/conjur-server .
COPY --from=builder ${GEM_HOME} ${GEM_HOME}

COPY . .

COPY .pryrc /root

EXPOSE ${PORT}
CMD ["sleep", "infinity"]
