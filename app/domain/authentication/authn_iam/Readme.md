# AWS Authenticator

This authenticator enables workloads running in AWS to authenticate with Conjur.

## Policy

The AWS Authenticator Policy follows the typical pattern for Authenticators.  Please note, there are no required variables.

### Authenticator Policy

```yaml
# Applied to the root policy
- !policy
  id: conjur
  body:
  - !policy
    id: authn-iam
    body:
    - !policy
      id: aws
      body:
      - !webservice

      - !group authenticatable

      - !permit
        role: !group authenticatable
        privilege: [ read, authenticate ]
        resource: !webservice
```

### Host Policy

```yaml
# Applied to the root policy
- !policy
  id: aws
  body:
  - !policy
    id: production
    body:
    - &hosts
      - !host 188945769008/my_app_1
      - !host 188945769008/my-app-2
      - !host 188945769008/MyApp3

  - !grant
    members: *hosts
    role: !group conjur/authn-iam/aws/authenticatable
```

### How IAM ARNs map to Conjur Roles

The Conjur AWS Authenticator receives an AWS ARN as a result of the authorization request. Below is a sample:

```
arn:aws:sts::188945769008:assumed-role/conjur-role/i-08241b0e31fe23d20
```

The interesting bits (from Conjur's perspective) are as follows:

- `188945769008` - AWS account ID
- `conjur-role` - IAM role given to this workload

All other elements or the AWS ARN are ignored by Conjur.

- The Conjur Role ID must end with `188945769008/conjur-role`
- The Role can be located in a Conjur policy (ie. can have the prefix: `foo/bar/188945769008/conjur-role`)
- A Role can be either a User or a Host
- A Host can be in the Conjur `root` policy
- A User cannot be in the Conjur `root` policy

## Authentication Workflow

The authenticator works by passing the headers generated by an AWS signing request to the AWS STS's (Security Token Service) `GetCallerIdentity` endpoint.  Conjur uses this signed service to exectute a call to AWS STS (on behalf of the workload we're authenticating).

AWS STS has two options, global (`sts.amazonaws.com`), and regional (`sts.<region>.amazonaws.com`). Some important notes about using the STS endpoint.

- If using the global endpoint (`sts.amazonaws.com`), the request must be signed using the `us-east-1` region. Signing a request using a different region will cause authentication to fail.
- If using the regional endpoint (preferred by AWS), the request must be signed by by that region. For example, if a request to `sts.eu-west-1.amazonaws.com`, it must be signed with the `eu-west-1` region.

### Examples

*All examples are in Ruby.*

*All examples assume the AWS IAM role of the requestor is `my-app-2`*

#### Valid Global Request

```ruby
require 'aws-sigv4'
require 'aws-sdk'

signed_aws_headers = Aws::Sigv4::Signer.new(
  service: 'sts',
  region: 'us-east-1',
  credentials_provider: Aws::InstanceProfileCredentials.new
).sign_request(
  http_method: 'GET',
  url: 'https://sts.amazonaws.com/?Action=GetCallerIdentity&Version=2011-06-15'
).headers
```

#### Valid Regional Request

Any region can be used as long as the region is the same the target regional STS endpoint.

```ruby
require 'aws-sigv4'
require 'aws-sdk'

signed_aws_headers = Aws::Sigv4::Signer.new(
  service: 'sts',
  region: 'eu-west-1',
  credentials_provider: Aws::InstanceProfileCredentials.new
).sign_request(
  http_method: 'GET',
  url: 'https://sts.eu-west-1.amazonaws.com/?Action=GetCallerIdentity&Version=2011-06-15'
).headers
```

#### Retrieve a Conjur Authentication Token

*Please note, the Ruby SDK does not support many of the authenticators via the SDK. The following is one example of how it might be handled.*

```ruby
# Retrieve a Conjur authentication token
conjur_host = 'host/aws/production/188945769008/my-app-2'
conjur_url = 'conjur.mycompany.com'
conjur_account = 'demo'

conjur_uri = URI("https://#{conjur_url}/authn-iam/aws/#{conjur_account}/#{ERB::Util.url_encode(conjur_host)}/authenticate")

response = Net::HTTP.post_form(conjur_uri, signed_aws_headers)

Conjur::API.new_from_token(response.body)
```

## Troubleshooting

  1. *Error: CONJ00018E Invalid or expired AWS headers: Credential should be scoped to a valid region.*

      Request was signed by another region. If using the global endpoint, make sure the request was signed using `us-east-1`. If using the regional endpoint, make sure the regional signing request was signed with the corresponding region.

  2. *Error: CONJ00018E Invalid or expired AWS headers: Signature expired: 20230518T152442Z is now earlier than 20230518T153438Z (20230518T154938Z - 15 min.)*

      The provided headers are no longer validate. Please regenerate the signing request and re-authenticate.

  3. *Error: CONJ00018E Invalid or expired AWS headers: The request signature we calculated does not match the signature you provided. Check your AWS Secret Access Key and signing method. Consult the service documentation for details.*

      The provided headers do not exactly match:

      ```
      GET https://sts.amazonaws.com/?Action=GetCallerIdentity&Version=2011-06-15
      ```

      or

      ```
      GET https://sts.<region>.amazonaws.com/?Action=GetCallerIdentity&Version=2011-06-15
      ```

      - Verify the signing request uses 'GET' and not another HTTP verb.
      - Verify the STS request includes the above parameters.
      - If crafting your own signed request (ex. when using Powershell), verify your signed request headers against the above endpoints using a tool like Postman.
